{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <button onclick="history.back()" class="p-2 mr-2 rounded-lg hover:bg-gray-100">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900">Update Profile</h1>
                        <p class="text-xs text-gray-600">Edit your mentor profile</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="p-4">
        <!-- Profile Image Section -->
        <div class="bg-white rounded-xl border border-gray-200 mb-4">
            <div class="p-4">
                <div class="flex items-center mb-4">
                    <div class="relative">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center overflow-hidden">
                            {% if current_user.profile_image %}
                            <img src="{{ url_for('static', filename=current_user.profile_image) }}" 
                                 alt="{{ current_user.full_name or current_user.username }}" 
                                 class="w-full h-full object-cover">
                            {% else %}
                            <span class="text-xl font-bold text-white">
                                {{ (current_user.full_name or current_user.username)[0].upper() }}
                            </span>
                            {% endif %}
                        </div>
                        <form method="POST" enctype="multipart/form-data" id="profileImageForm" class="mt-2">
                            <label for="profile_image" class="text-sm font-medium text-blue-600 hover:text-blue-700 cursor-pointer">
                                Change photo
                            </label>
                            <input type="file" 
                                   id="profile_image" 
                                   name="profile_image" 
                                   accept="image/*"
                                   class="hidden"
                                   onchange="document.getElementById('profileImageForm').submit()">
                        </form>
                    </div>
                    
                    <div class="ml-4">
                        <h3 class="font-bold text-gray-900">{{ current_user.full_name or current_user.username }}</h3>
                        <p class="text-sm text-gray-600">{{ current_user.job_title or 'Mentor' }}</p>
                        <div class="mt-1">
                            {% if current_user.is_verified %}
                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Verified
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Pending Review
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Form -->
        <div class="bg-white rounded-xl border border-gray-200">
            <form method="POST" enctype="multipart/form-data">
                <div class="p-4">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Profile Information</h2>
                    
                    <!-- Personal Information -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                            <input type="text" name="full_name" value="{{ current_user.full_name or '' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="text" name="phone" value="{{ current_user.phone or '' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <!-- Professional Information -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Job Title *</label>
                            <input type="text" name="job_title" value="{{ current_user.job_title or '' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Company *</label>
                            <input type="text" name="company" value="{{ current_user.company or '' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                    </div>
                    
                    <!-- Expertise -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Domain/Expertise *</label>
                            <input type="text" name="domain" value="{{ current_user.domain or '' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Experience *</label>
                            <input type="text" name="experience" value="{{ current_user.experience or '' }}"
                                   placeholder="e.g., 5 years"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                    </div>
                    
                    <!-- Skills -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Skills (comma separated)</label>
                        <input type="text" name="skills" value="{{ current_user.skills or '' }}"
                               placeholder="Python, Machine Learning, Data Analysis"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Bio -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bio *</label>
                        <textarea name="bio" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  required>{{ current_user.bio or '' }}</textarea>
                    </div>
                    
                    <!-- Additional Information (Collapsible) -->
                    <div class="mb-6">
                        <button type="button" 
                                onclick="toggleSection('additional-info')"
                                class="flex items-center justify-between w-full py-2 text-left text-sm font-medium text-gray-700">
                            <span>Additional Information</span>
                            <svg class="w-5 h-5 text-gray-500" id="additional-info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        
                        <div id="additional-info" class="hidden space-y-4 mt-3">
                            <!-- Availability -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Availability</label>
                                <input type="text" name="availability" value="{{ current_user.availability or '' }}"
                                       placeholder="Weekdays 6-9 PM, Weekends 10 AM - 6 PM"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <!-- Previous Company -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Previous Company</label>
                                <input type="text" name="previous_company" value="{{ current_user.previous_company or '' }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <!-- Default Price -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Default Price (â‚¹)</label>
                                <input type="number" name="price" value="{{ current_user.price or '' }}"
                                       min="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    <!-- Update the booking section to use proper API endpoints -->
<script>
    async function loadTimeSlots(date) {
        const mentorId = {{ mentor.mentor.id if mentor.mentor else 0 }};
        if (!mentorId) return;
        
        try {
            const response = await fetch(`/api/available-slots/${mentorId}?date=${date}`);
            const data = await response.json();
            
            if (data.success) {
                // Update time slots UI
                updateTimeSlotsUI(data.slots);
            }
        } catch (error) {
            console.error('Error loading time slots:', error);
        }
    }
    
    async function createBooking() {
        const serviceSelect = document.getElementById('quick-service');
        const dateInput = document.getElementById('selected-date');
        const timeSelect = document.getElementById('selected-time');
        
        if (!serviceSelect.value || !dateInput.value || !timeSelect.value) {
            showNotification('Please select service, date, and time', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('service_id', serviceSelect.value);
        formData.append('scheduled_for', dateInput.value);
        formData.append('time_slot', timeSelect.value);
        
        try {
            const response = await fetch('/api/create-booking', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Initialize Razorpay
                const options = {
                    "key": data.key_id,
                    "amount": data.amount * 100,
                    "currency": "INR",
                    "name": "ClearQ Mentorship",
                    "description": "Booking Payment",
                    "order_id": data.order_id,
                    "handler": function(response) {
                        verifyPayment(response, data.booking_id);
                    },
                    "prefill": {
                        "name": "{{ current_user.full_name if current_user else '' }}",
                        "email": "{{ current_user.email if current_user else '' }}",
                    },
                    "theme": {
                        "color": "#2563eb"
                    }
                };
                
                const razorpay = new Razorpay(options);
                razorpay.open();
            }
        } catch (error) {
            console.error('Error creating booking:', error);
            showNotification('Failed to create booking', 'error');
        }
    }
    
    async function verifyPayment(paymentResponse, bookingId) {
        const formData = new FormData();
        formData.append('razorpay_order_id', paymentResponse.razorpay_order_id);
        formData.append('razorpay_payment_id', paymentResponse.razorpay_payment_id);
        formData.append('razorpay_signature', paymentResponse.razorpay_signature);
        
        try {
            const response = await fetch('/api/verify-payment', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Payment successful! Booking confirmed.', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            }
        } catch (error) {
            console.error('Error verifying payment:', error);
            showNotification('Payment verification failed', 'error');
        }
    }
</script>
                    <!-- Social Media (Collapsible) -->
                    <div class="mb-6">
                        <button type="button" 
                                onclick="toggleSection('social-media')"
                                class="flex items-center justify-between w-full py-2 text-left text-sm font-medium text-gray-700">
                            <span>Social Media Links</span>
                            <svg class="w-5 h-5 text-gray-500" id="social-media-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        
                        <div id="social-media" class="hidden space-y-4 mt-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn</label>
                                <input type="url" name="linkedin_url" value="{{ current_user.linkedin_url or '' }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Instagram</label>
                                <input type="url" name="instagram_url" value="{{ current_user.instagram_url or '' }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">YouTube</label>
                                <input type="url" name="youtube_url" value="{{ current_user.youtube_url or '' }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Facebook</label>
                                <input type="url" name="facebook_url" value="{{ current_user.facebook_url or '' }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics (Collapsible) -->
                    <div class="mb-6">
                        <button type="button" 
                                onclick="toggleSection('performance-metrics')"
                                class="flex items-center justify-between w-full py-2 text-left text-sm font-medium text-gray-700">
                            <span>Performance Metrics</span>
                            <svg class="w-5 h-5 text-gray-500" id="performance-metrics-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        
                        <div id="performance-metrics" class="hidden space-y-4 mt-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Success Rate (%)</label>
                                <input type="number" name="success_rate" value="{{ current_user.success_rate or 95 }}"
                                       min="0" max="100"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Response Rate (%)</label>
                                <input type="number" name="response_rate" value="{{ current_user.response_rate or 98 }}"
                                       min="0" max="100"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="flex gap-3 pt-4 border-t border-gray-200">
                        <a href="{{ url_for('dashboard') }}" 
                           class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 text-center">
                            Cancel
                        </a>
                        <button type="submit" 
                                class="flex-1 px-4 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">
                            Update Profile
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Toggle collapsible sections
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId + '-icon');
    
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
    } else {
        section.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
    }
}

// Auto-submit profile image when file is selected
document.getElementById('profile_image').addEventListener('change', function() {
    if (this.files[0]) {
        document.getElementById('profileImageForm').submit();
    }
});

// Keep form from submitting when hitting enter on non-form fields
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'BUTTON') {
        e.preventDefault();
    }
});
</script>
{% endblock %}

