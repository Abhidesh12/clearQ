{% extends "base.html" %}

{% block title %}Complete Payment - ClearQ{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-lock me-2"></i>Secure Payment
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Order Summary -->
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">Order Summary</h5>
                                    <hr>
                                    
                                    <div class="mb-3">
                                        <h6 class="text-muted">Service Details</h6>
                                        <p class="mb-1"><strong>{{ booking.service_name }}</strong></p>
                                        {% if booking.slot_time %}
                                        <p class="mb-1">
                                            <i class="far fa-calendar me-2"></i>
                                            {{ booking.booking_date.strftime('%B %d, %Y') if booking.booking_date else 'Date to be scheduled' }}
                                        </p>
                                        <p class="mb-1">
                                            <i class="far fa-clock me-2"></i>
                                            {{ booking.slot_time }}
                                        </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="text-muted">Mentor</h6>
                                        <p class="mb-0">
                                            <i class="fas fa-user-tie me-2"></i>
                                            {{ booking.mentor.full_name if booking.mentor else 'Unknown Mentor' }}
                                        </p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="text-muted">Payment Details</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Amount:</span>
                                            <strong>₹{{ booking.price or 0 }}</strong>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Platform Fee:</span>
                                            <span>₹0</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <span class="h5">Total:</span>
                                            <span class="h5 text-success">₹{{ booking.price or 0 }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <small>
                                            <i class="fas fa-shield-alt me-2"></i>
                                            <strong>Secure Payment:</strong> Your payment is processed through Razorpay's secure gateway.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Form -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <h5 class="mb-3">Complete Your Payment</h5>
                                <p class="text-muted">
                                    Please review your order and complete the payment to confirm your booking.
                                </p>
                            </div>
                            
                            <div id="payment-container">
                                <form id="payment-form">
                                    <div class="mb-3">
                                        <label class="form-label">Payment Amount</label>
                                        <div class="input-group">
                                            <span class="input-group-text">₹</span>
                                            <input type="text" class="form-control" value="{{ booking.price or 0 }}" readonly>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Order ID</label>
                                        <input type="text" class="form-control" value="{{ order_id }}" readonly>
                                    </div>
                                    
                                    <div class="alert alert-warning">
                                        <small>
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Please do not refresh or close this page during payment.
                                        </small>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button type="button" id="pay-button" class="btn btn-success btn-lg">
                                            <i class="fas fa-credit-card me-2"></i>Pay ₹{{ booking.price or 0 }}
                                        </button>
                                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                            Cancel Payment
                                        </a>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="text-muted mb-3">Accepted Payment Methods</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge bg-light text-dark p-2">
                                        <i class="fab fa-cc-visa fa-2x me-1"></i> Visa
                                    </span>
                                    <span class="badge bg-light text-dark p-2">
                                        <i class="fab fa-cc-mastercard fa-2x me-1"></i> Mastercard
                                    </span>
                                    <span class="badge bg-light text-dark p-2">
                                        <i class="fab fa-cc-amex fa-2x me-1"></i> Amex
                                    </span>
                                    <span class="badge bg-light text-dark p-2">
                                        <i class="fas fa-mobile-alt fa-2x me-1"></i> UPI
                                    </span>
                                    <span class="badge bg-light text-dark p-2">
                                        <i class="fas fa-wallet fa-2x me-1"></i> Wallet
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Razorpay Integration -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const payButton = document.getElementById('pay-button');
    const amount = {{ booking.price or 0 }} * 100; // Convert to paise
    const orderId = '{{ order_id }}';
    const keyId = '{{ key_id }}';
    
    payButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Disable button to prevent multiple clicks
        payButton.disabled = true;
        payButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        
        const options = {
            "key": keyId,
            "amount": amount,
            "currency": "INR",
            "name": "ClearQ Mentorship",
            "description": "Payment for {{ booking.service_name }}",
            "image": "{{ url_for('static', filename='img/logo.png') }}",
            "order_id": orderId,
            "handler": function(response) {
                // Create a form and submit it to the server
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("payment_success") }}';
                
                const razorpay_payment_id = document.createElement('input');
                razorpay_payment_id.type = 'hidden';
                razorpay_payment_id.name = 'razorpay_payment_id';
                razorpay_payment_id.value = response.razorpay_payment_id;
                
                const razorpay_order_id = document.createElement('input');
                razorpay_order_id.type = 'hidden';
                razorpay_order_id.name = 'razorpay_order_id';
                razorpay_order_id.value = response.razorpay_order_id;
                
                const razorpay_signature = document.createElement('input');
                razorpay_signature.type = 'hidden';
                razorpay_signature.name = 'razorpay_signature';
                razorpay_signature.value = response.razorpay_signature;
                
                form.appendChild(razorpay_payment_id);
                form.appendChild(razorpay_order_id);
                form.appendChild(razorpay_signature);
                
                document.body.appendChild(form);
                form.submit();
            },
            "prefill": {
                "name": "{{ user.full_name or user.username }}",
                "email": "{{ user.email }}",
                "contact": "{{ user.phone or '' }}"
            },
            "theme": {
                "color": "#4a6baf"
            },
            "modal": {
                "ondismiss": function() {
                    // Re-enable button if payment is cancelled
                    payButton.disabled = false;
                    payButton.innerHTML = '<i class="fas fa-credit-card me-2"></i>Pay ₹{{ booking.price or 0 }}';
                }
            }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
        
        rzp.on('payment.failed', function(response) {
            window.location.href = "{{ url_for('payment_failed') }}?order_id=" + orderId;
        });
    });
});

// Auto-open payment modal on page load (optional)
// window.onload = function() {
//     document.getElementById('pay-button').click();
// };
</script>

<style>
.card {
    border-radius: 10px;
    border: none;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

.btn-success {
    background-color: #28a745;
    border-color: #28a745;
    padding: 12px 20px;
    font-weight: 500;
}

.btn-success:hover {
    background-color: #218838;
    border-color: #1e7e34;
}

.btn-success:disabled {
    background-color: #28a745;
    border-color: #28a745;
}

.input-group-text {
    background-color: #f8f9fa;
}

.badge {
    border: 1px solid #dee2e6;
    border-radius: 5px;
}

.alert-info {
    background-color: #e8f4fd;
    border-color: #b6d4fe;
    color: #084298;
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #ffecb5;
    color: #856404;
}
</style>
{% endblock %}
