{% extends "base.html" %}
{% block title %}{{ service.name }} with {{ mentor.full_name }} - ClearQ Mentor{% endblock %}

{% block content %}
<style>
    .service-detail-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 24px;
        padding: 8px 16px;
        border-radius: 8px;
        background: #f8fafc;
        transition: all 0.2s;
    }
    
    .back-button:hover {
        background: #eef2ff;
        transform: translateX(-4px);
    }
    
    .service-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 40px;
        color: white;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }
    
    .service-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        opacity: 0.3;
    }
    
    .service-header-content {
        position: relative;
        z-index: 1;
    }
    
    .service-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 8px;
    }
    
    .service-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 20px;
    }
    
    .service-price-large {
        font-size: 2.5rem;
        font-weight: 800;
        margin-top: 20px;
    }
    
    .service-price-large span {
        font-size: 1rem;
        opacity: 0.8;
    }
    
    .service-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-top: 30px;
    }
    
    @media (max-width: 768px) {
        .service-layout {
            grid-template-columns: 1fr;
        }
    }
    
    .service-info-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .booking-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        position: sticky;
        top: 30px;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-title i {
        color: #667eea;
    }
    
    .description-content {
        font-size: 1.1rem;
        line-height: 1.6;
        color: #4b5563;
    }
    
    .description-content ul {
        margin: 16px 0;
        padding-left: 20px;
    }
    
    .description-content li {
        margin-bottom: 8px;
    }
    
    /* Date Selection */
    .date-selector {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        overflow-x: auto;
        padding: 10px 0;
        scrollbar-width: thin;
    }
    
    .date-item {
        min-width: 80px;
        padding: 15px 10px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
        flex-shrink: 0;
    }
    
    .date-item:hover {
        border-color: #667eea;
        transform: translateY(-2px);
    }
    
    .date-item.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }
    
    .date-day {
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .date-number {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 5px 0;
    }
    
    .date-month {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    /* Time Slots */
    .time-slots-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 20px 0;
    }
    
    @media (max-width: 640px) {
        .time-slots-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    .time-slot {
        padding: 15px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
        font-weight: 500;
    }
    
    .time-slot:hover {
        border-color: #667eea;
        background: #f8fafc;
    }
    
    .time-slot.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }
    
    /* Booking Form */
    .booking-form {
        margin-top: 30px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    
    .form-input, .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s;
    }
    
    .form-input:focus, .form-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-textarea {
        min-height: 120px;
        resize: vertical;
    }
    
    .book-button {
        width: 100%;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 20px;
        position: relative;
        overflow: hidden;
    }
    
    .book-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .book-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .booking-summary {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .summary-item:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 1.2rem;
    }
    
    /* Features Grid */
    .features-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 30px 0;
    }
    
    @media (max-width: 640px) {
        .features-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .feature-item {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        transition: all 0.3s;
    }
    
    .feature-item:hover {
        background: #eef2ff;
        transform: translateY(-2px);
    }
    
    .feature-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .feature-content h4 {
        margin: 0 0 5px 0;
        color: #1f2937;
        font-weight: 600;
    }
    
    .feature-content p {
        margin: 0;
        color: #6b7280;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    /* Loading States */
    .loading {
        text-align: center;
        padding: 40px;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Mentor Info */
    .mentor-info-sidebar {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
    }
    
    .mentor-avatar-small {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 15px;
    }
    
    .other-services {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #e5e7eb;
    }
    
    .other-services-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .other-service-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s;
        text-decoration: none;
        color: inherit;
        display: block;
    }
    
    .other-service-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-color: #667eea;
    }
    
    .other-service-name {
        font-weight: 600;
        margin-bottom: 8px;
        color: #1f2937;
    }
    
    .other-service-price {
        color: #667eea;
        font-weight: 700;
        font-size: 1.2rem;
    }
</style>

<div class="service-detail-container">
    <!-- Back Button -->
    <a href="{{ url_for('mentor_public_profile', username=mentor.username) }}" class="back-button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to {{ mentor.full_name }}'s Profile
    </a>
    
    <!-- Service Header -->
    <div class="service-header">
        <div class="service-header-content">
            <h1 class="service-title">{{ service.name }}</h1>
            <p class="service-subtitle">with {{ mentor.full_name }}</p>
            <div class="service-price-large">
                ₹{{ service.price }}
                <span>/ session</span>
            </div>
        </div>
    </div>
    
    <div class="service-layout">
        <!-- Left Column: Service Information -->
        <div class="service-info-card">
            <h2 class="section-title">
                <i class="fas fa-info-circle"></i>
                About This Service
            </h2>
            
            <div class="description-content">
                {{ service.detailed_description|safe if service.detailed_description else service.description }}
            </div>
            
            {% if service.duration %}
            <div class="features-grid">
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="feature-content">
                        <h4>Session Duration</h4>
                        <p>{{ service.duration }}</p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="feature-content">
                        <h4>Personalized Approach</h4>
                        <p>Tailored to your specific needs and goals</p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="feature-content">
                        <h4>Expert Guidance</h4>
                        <p>From {{ mentor.experience or '5+' }} years of experience</p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="feature-content">
                        <h4>Satisfaction Guarantee</h4>
                        <p>Full refund if you're not satisfied</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Mentor Info Sidebar -->
            <div class="mentor-info-sidebar">
                <div class="mentor-avatar-small">
                    {% if mentor.profile_image %}
                        <img src="{{ url_for('static', filename=mentor.profile_image) }}" 
                             alt="{{ mentor.full_name }}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
                    {% else %}
                        {{ mentor.full_name[0].upper() if mentor.full_name else mentor.username[0].upper() }}
                    {% endif %}
                </div>
                <h3 style="margin-bottom: 10px; color: #1f2937;">{{ mentor.full_name or mentor.username }}</h3>
                {% if mentor.job_title %}
                <p style="color: #6b7280; margin-bottom: 5px;">{{ mentor.job_title }}</p>
                {% endif %}
                {% if mentor.company %}
                <p style="color: #6b7280; margin-bottom: 15px;">{{ mentor.company }}</p>
                {% endif %}
                <div style="display: flex; gap: 10px; font-size: 0.9rem;">
                    <span style="display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-star" style="color: #fbbf24;"></i>
                        {{ mentor.rating or '4.9' }}
                    </span>
                    <span style="display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-calendar-check" style="color: #10b981;"></i>
                        {{ mentor.success_rate or '95' }}% success
                    </span>
                </div>
            </div>
            
            <!-- Other Services -->
            {% if other_services %}
            <div class="other-services">
                <h2 class="section-title">
                    <i class="fas fa-th-list"></i>
                    Other Services by {{ mentor.full_name }}
                </h2>
                <div class="other-services-grid">
                    {% for other_service in other_services %}
                    <a href="{{ url_for('service_detail', username=mentor.username, service_slug=other_service.slug) }}" 
                       class="other-service-card">
                        <div class="other-service-name">{{ other_service.name }}</div>
                        <div class="other-service-price">₹{{ other_service.price }}</div>
                        <p style="color: #6b7280; font-size: 0.9rem; margin-top: 8px;">{{ other_service.description[:80] }}...</p>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Right Column: Booking Card -->
        <div class="booking-card">
            <h2 class="section-title">
                <i class="fas fa-calendar-plus"></i>
                Book This Session
            </h2>
            
            <div class="booking-summary">
                <div class="summary-item">
                    <span>Service:</span>
                    <span>{{ service.name }}</span>
                </div>
                <div class="summary-item">
                    <span>Price:</span>
                    <span style="color: #667eea; font-weight: 600;">₹{{ service.price }}</span>
                </div>
                <div class="summary-item">
                    <span>Duration:</span>
                    <span>{{ service.duration or '1 hour' }}</span>
                </div>
            </div>
            
            {% if current_user.is_authenticated and current_user.role == 'learner' %}
            <form method="POST" action="{{ url_for('book_service', service_id=service.id) }}" class="booking-form">
                <!-- Date Selection -->
                <div class="form-group">
                    <label class="form-label">Select Date</label>
                    <div class="date-selector" id="dateSelector">
                        {% for date_info in available_dates %}
                        <div class="date-item {% if loop.first %}selected{% endif %}" 
                             data-date="{{ date_info.full_date }}"
                             onclick="selectDate(this, '{{ date_info.full_date }}')">
                            <div class="date-day">{{ date_info.day_name }}</div>
                            <div class="date-number">{{ date_info.day_num }}</div>
                            <div class="date-month">{{ date_info.month }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="booking-date" name="date" value="{{ available_dates[0].full_date if available_dates else '' }}">
                </div>
                
                <!-- Time Slot Selection -->
                <div class="form-group">
                    <label class="form-label">Select Time Slot</label>
                    <div class="time-slots-grid" id="timeSlotsContainer">
                        {% for slot in available_slots %}
                        <div class="time-slot" onclick="selectTimeSlot(this, '{{ slot }}')">
                            {{ slot }}
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="booking-time" name="slot" value="">
                </div>
                
                <!-- Additional Notes -->
                <div class="form-group">
                    <label class="form-label">Additional Notes (Optional)</label>
                    <textarea name="notes" class="form-textarea" 
                              placeholder="Any specific topics or questions you'd like to focus on during the session..."></textarea>
                </div>
                
                <!-- Booking Summary -->
                <div class="booking-summary" id="dynamicSummary" style="display: none;">
                    <div class="summary-item">
                        <span>Selected Date:</span>
                        <span id="summary-date">Not selected</span>
                    </div>
                    <div class="summary-item">
                        <span>Selected Time:</span>
                        <span id="summary-time">Not selected</span>
                    </div>
                    <div class="summary-item">
                        <span>Total:</span>
                        <span style="color: #667eea; font-weight: 600;">₹{{ service.price }}</span>
                    </div>
                </div>
                
                <button type="submit" class="book-button" id="bookButton" disabled>
                    <span id="buttonText">Select Date & Time to Book</span>
                    <span id="bookingDetails" style="display: block; font-size: 0.9rem; opacity: 0.8; margin-top: 5px;"></span>
                </button>
            </form>
            
            {% elif not current_user.is_authenticated %}
            <div style="text-align: center; padding: 40px 20px;">
                <div style="width: 80px; height: 80px; background: #eef2ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <i class="fas fa-lock" style="font-size: 2rem; color: #667eea;"></i>
                </div>
                <h3 style="color: #1f2937; margin-bottom: 10px;">Login Required</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">Please login to book this session</p>
                <a href="{{ url_for('login') }}?next={{ request.path }}" 
                   style="display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 10px; font-weight: 600;">
                    Login to Book
                </a>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px 20px;">
                <div style="width: 80px; height: 80px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <i class="fas fa-user-slash" style="font-size: 2rem; color: #ef4444;"></i>
                </div>
                <h3 style="color: #1f2937; margin-bottom: 10px;">Only for Learners</h3>
                <p style="color: #6b7280;">Only learners can book mentor sessions</p>
            </div>
            {% endif %}
            
            <!-- Guarantee Section -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 40px; height: 40px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #1f2937;">100% Satisfaction Guarantee</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Full refund if you're not satisfied with the session</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let selectedDate = '{{ available_dates[0].full_date if available_dates else "" }}';
let selectedTime = '';

// Function to select date
function selectDate(element, date) {
    // Update UI
    document.querySelectorAll('.date-item').forEach(item => {
        item.classList.remove('selected');
    });
    element.classList.add('selected');
    
    selectedDate = date;
    document.getElementById('booking-date').value = date;
    
    // Update summary
    const dateObj = new Date(date);
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    document.getElementById('summary-date').textContent = dateObj.toLocaleDateString('en-US', options);
    
    // Load time slots for selected date
    loadTimeSlotsForDate(date);
}

// Function to select time slot
function selectTimeSlot(element, time) {
    // Update UI
    document.querySelectorAll('.time-slot').forEach(item => {
        item.classList.remove('selected');
    });
    element.classList.add('selected');
    
    selectedTime = time;
    document.getElementById('booking-time').value = time;
    
    // Update summary and button
    updateBookingSummary();
    updateBookButton();
}

// Function to load time slots for a specific date
async function loadTimeSlotsForDate(date) {
    const timeSlotsContainer = document.getElementById('timeSlotsContainer');
    timeSlotsContainer.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading available time slots...</p>
        </div>
    `;
    
    try {
        const mentorId = {{ mentor.id }};
        const response = await fetch('/api/get-time-slots/' + mentorId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ date: date })
        });
        
        const data = await response.json();
        
        if (data.success && data.slots && data.slots.length > 0) {
            timeSlotsContainer.innerHTML = data.slots.map(slot => 
                `<div class="time-slot" onclick="selectTimeSlot(this, '${slot}')">${slot}</div>`
            ).join('');
            
            // Auto-select first time slot if none selected
            if (!selectedTime) {
                const firstSlot = timeSlotsContainer.querySelector('.time-slot');
                if (firstSlot) {
                    selectTimeSlot(firstSlot, data.slots[0]);
                }
            }
        } else {
            timeSlotsContainer.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #dc2626; background: #fef2f2; border-radius: 10px;">
                    <i class="fas fa-calendar-times" style="font-size: 1.5rem; margin-bottom: 10px;"></i>
                    <p>No available time slots for this date. Please select another date.</p>
                </div>
            `;
            selectedTime = '';
            document.getElementById('booking-time').value = '';
            updateBookingSummary();
            updateBookButton();
        }
    } catch (error) {
        console.error('Error loading time slots:', error);
        timeSlotsContainer.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #dc2626; background: #fef2f2; border-radius: 10px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 10px;"></i>
                <p>Error loading time slots. Please try again.</p>
            </div>
        `;
    }
}

// Function to update booking summary
function updateBookingSummary() {
    const dynamicSummary = document.getElementById('dynamicSummary');
    const summaryTime = document.getElementById('summary-time');
    
    if (selectedTime) {
        summaryTime.textContent = selectedTime;
        dynamicSummary.style.display = 'block';
    } else {
        dynamicSummary.style.display = 'none';
    }
}

// Function to update book button
function updateBookButton() {
    const button = document.getElementById('bookButton');
    const buttonText = document.getElementById('buttonText');
    const bookingDetails = document.getElementById('bookingDetails');
    
    if (selectedDate && selectedTime) {
        const dateObj = new Date(selectedDate);
        const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        
        button.disabled = false;
        buttonText.textContent = `Book Session for ₹{{ service.price }}`;
        bookingDetails.textContent = `${dateStr} at ${selectedTime}`;
        bookingDetails.style.display = 'block';
    } else {
        button.disabled = true;
        buttonText.textContent = 'Select Date & Time to Book';
        bookingDetails.textContent = '';
        bookingDetails.style.display = 'none';
    }
}

// Check URL parameters for pre-selected date/time
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const urlDate = urlParams.get('date');
    const urlTime = urlParams.get('time');
    
    if (urlDate) {
        // Find and click the date element
        const dateElement = document.querySelector(`.date-item[data-date="${urlDate}"]`);
        if (dateElement) {
            dateElement.click();
            
            // If time is also in URL, select it after a delay
            if (urlTime) {
                setTimeout(() => {
                    const decodedTime = decodeURIComponent(urlTime);
                    const timeElements = document.querySelectorAll('.time-slot');
                    timeElements.forEach(element => {
                        if (element.textContent.trim() === decodedTime) {
                            selectTimeSlot(element, decodedTime);
                        }
                    });
                }, 800);
            }
        }
    } else {
        // Initialize with first date selected
        const firstDateElement = document.querySelector('.date-item');
        if (firstDateElement) {
            firstDateElement.click();
        }
    }
});
</script>
{% endblock %}
